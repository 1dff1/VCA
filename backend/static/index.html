<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Call</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: #252525;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 600px;
            overflow: hidden;
        }

        .header {
            background: #333333;
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #404040;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
            color: #ffffff;
        }

        .header p {
            font-size: 13px;
            color: #888888;
        }

        .content {
            padding: 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #cccccc;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            background: #333333;
            border: 2px solid #404040;
            border-radius: 8px;
            color: #ffffff;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #00a8ff;
        }

        .search-input {
            padding: 10px 15px;
            margin-bottom: 15px;
            background: #333333;
            border: 2px solid #404040;
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
            width: 100%;
        }

        .search-input::placeholder {
            color: #888888;
        }

        .search-input:focus {
            outline: none;
            border-color: #00a8ff;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .btn-primary {
            background: #00a8ff;
            color: white;
        }

        .btn-primary:hover {
            background: #0097e6;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-danger:hover {
            background: #ff3844;
        }

        .btn-success {
            background: #2ed573;
            color: white;
        }

        .btn-success:hover {
            background: #2ccda8;
        }

        .btn-secondary {
            background: #575fcf;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b54c4;
        }

        .users-list {
            margin-top: 10px;
        }

        .users-list h3 {
            margin-bottom: 15px;
            color: #cccccc;
            font-size: 16px;
            font-weight: 500;
        }

        .user-item {
            padding: 12px 15px;
            background: #333333;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid #00a8ff;
        }

        .user-item:hover {
            background: #3d3d3d;
            transform: translateX(3px);
        }

        .user-item .username {
            font-weight: 500;
            color: #ffffff;
        }

        .user-item .status {
            background: #2ed573;
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }

        .call-info {
            text-align: center;
            margin-bottom: 25px;
        }

        .call-info h3 {
            font-size: 18px;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .call-info p {
            color: #888888;
            font-size: 13px;
        }

        .call-controls {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .call-controls button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-decline {
            background: #ff4757;
            color: white;
        }

        .btn-decline:hover {
            background: #ff3844;
        }

        .btn-accept {
            background: #2ed573;
            color: white;
        }

        .btn-accept:hover {
            background: #2ccda8;
        }

        .btn-hangup {
            background: #ff4757;
            color: white;
            padding: 14px;
            width: 100%;
            margin-top: 20px;
        }

        .btn-hangup:hover {
            background: #ff3844;
        }

        .connection-status {
            text-align: center;
            margin-top: 15px;
            font-size: 12px;
            padding: 8px;
            border-radius: 6px;
        }

        .connection-status.connected {
            background: rgba(46, 213, 115, 0.1);
            color: #2ed573;
        }

        .connection-status.disconnected {
            background: rgba(255, 71, 87, 0.1);
            color: #ff4757;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #333333;
            color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666666;
        }

        .empty-state p {
            margin-top: 10px;
            font-size: 14px;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∑–≤—É–∫–∞ */
        .audio-indicators {
            display: flex;
            justify-content: space-between;
            margin: 25px 0;
            gap: 20px;
        }

        .audio-indicator {
            text-align: center;
            flex: 1;
        }

        .audio-indicator label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: #888888;
            font-size: 13px;
        }

        .level-bars {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 50px;
            gap: 2px;
        }

        .level-bar {
            width: 4px;
            height: 2px;
            background: #404040;
            border-radius: 2px;
            transition: height 0.1s, background 0.1s;
        }

        .level-bar.active {
            background: #00a8ff;
            height: 25px;
        }

        .level-bar.very-active {
            background: #ff4757;
            height: 50px;
        }

        .remote .level-bar.active {
            background: #2ed573;
        }

        .remote .level-bar.very-active {
            background: #2ed573;
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading {
            text-align: center;
            padding: 30px;
        }

        .spinner {
            border: 3px solid #404040;
            border-top: 3px solid #00a8ff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ */
        .logout-btn {
            background: none;
            border: 1px solid #ff4757;
            color: #ff4757;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255, 71, 87, 0.1);
        }

        /* –°–µ–∫—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è */
        .profile-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .profile-section h3 {
            font-size: 16px;
            color: #ffffff;
            margin-bottom: 5px;
        }

        .profile-section p {
            font-size: 13px;
            color: #888888;
        }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ */
        .search-results {
            font-size: 12px;
            color: #888888;
            margin-bottom: 10px;
            text-align: right;
        }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–≤—Ö–æ–¥–∞ */
        .auth-switch {
            text-align: center;
            margin-top: 15px;
            font-size: 13px;
            color: #888888;
        }

        .auth-switch a {
            color: #00a8ff;
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        .error-message {
            color: #ff4757;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìû Voice Call</h1>
            <p>–ü—Ä–æ—Å—Ç—ã–µ –≥–æ–ª–æ—Å–æ–≤—ã–µ –∑–≤–æ–Ω–∫–∏</p>
        </div>

        <div class="content">
            <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
            <div class="section register-section active">
                <h2 style="text-align: center; margin-bottom: 25px; color: #ffffff;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <div class="input-group">
                    <label for="regUsername">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input type="text" id="regUsername" placeholder="–û—Ç 3 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤">
                    <div class="error-message" id="regUsernameError"></div>
                </div>
                <div class="input-group">
                    <label for="regPassword">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="regPassword" placeholder="–ú–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞">
                    <div class="error-message" id="regPasswordError"></div>
                </div>
                <button class="btn btn-primary" id="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <div class="auth-switch">
                    –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a id="showLogin">–í–æ–π—Ç–∏</a>
                </div>
            </div>

            <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
            <div class="section login-section">
                <h2 style="text-align: center; margin-bottom: 25px; color: #ffffff;">–í—Ö–æ–¥</h2>
                <div class="input-group">
                    <label for="loginUsername">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input type="text" id="loginUsername" placeholder="–í–∞—à–µ –∏–º—è">
                    <div class="error-message" id="loginUsernameError"></div>
                </div>
                <div class="input-group">
                    <label for="loginPassword">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="loginPassword" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å">
                    <div class="error-message" id="loginPasswordError"></div>
                </div>
                <button class="btn btn-success" id="loginBtn">–í–æ–π—Ç–∏</button>
                <div class="auth-switch">
                    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a id="showRegister">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <div class="section call-section">
                <div class="profile-section">
                    <h3 id="currentUsernameDisplay">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                    <button class="logout-btn" id="logoutBtn">–í—ã–π—Ç–∏</button>
                </div>
                <div class="users-list">
                    <h3>–û–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                    <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...">
                    <div class="search-results" id="searchResults"></div>
                    <div id="usersContainer">
                        <div class="empty-state">
                            <div class="spinner"></div>
                            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ -->
            <div class="section calling-section">
                <div class="call-info">
                    <h3>–í—ã–∑–æ–≤ <span id="callingUser"></span></h3>
                    <p>–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...</p>
                </div>
                <button class="btn btn-danger" id="cancelCallBtn">–û—Ç–º–µ–Ω–∏—Ç—å</button>
            </div>

            <!-- –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ -->
            <div class="section incoming-call-section">
                <div class="call-info">
                    <h3>–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤</h3>
                    <p>–û—Ç: <span id="incomingUser"></span></p>
                </div>
                <div class="call-controls">
                    <button class="btn btn-decline" id="declineBtn">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    <button class="btn btn-accept" id="acceptBtn">–ü—Ä–∏–Ω—è—Ç—å</button>
                </div>
            </div>

            <!-- –í –ø—Ä–æ—Ü–µ—Å—Å–µ –∑–≤–æ–Ω–∫–∞ -->
            <div class="section in-call-section">
                <div class="call-info">
                    <h3>–†–∞–∑–≥–æ–≤–æ—Ä —Å <span id="currentCallUser"></span></h3>
                    <p id="callDuration">00:00</p>
                </div>
                
                <div class="audio-indicators">
                    <div class="audio-indicator">
                        <label>üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω</label>
                        <div class="level-bars" id="micLevel">
                            <div class="level-bar"></div>
                            <div class="level-bar"></div>
                            <div class="level-bar"></div>
                            <div class="level-bar"></div>
                            <div class="level-bar"></div>
                            <div class="level-bar"></div>
                            <div class="level-bar"></div>
                            <div class="level-bar"></div>
                            <div class="level-bar"></div>
                            <div class="level-bar"></div>
                        </div>
                    </div>
                    <div class="audio-indicator remote">
                        <label>üéß –°–æ–±–µ—Å–µ–¥–Ω–∏–∫</label>
                        <div class="level-bars" id="remoteLevel">
                            <div class="level-bar"></div>
                            <div class="level-bar"></div>
                            <div class="level-bar"></div>
                            <div class="level-bar"></div>
                            <div class="level-bar"></div>
                            <div class="level-bar"></div>
                            <div class="level-bar"></div>
                            <div class="level-bar"></div>
                            <div class="level-bar"></div>
                            <div class="level-bar"></div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-danger btn-hangup" id="hangupBtn">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>
    <audio id="remoteAudio" autoplay></audio>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let socket = null;
        let peerConnection = null;
        let localStream = null;
        let remoteStream = null;
        let currentCallUser = null;
        let callTimer = null;
        let startTime = null;
        let sessionId = null;
        let currentUserId = null;
        let currentUsername = null;
        let allUsers = [];
        
        // –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—ã –∑–≤—É–∫–∞
        let audioContext = null;
        let localAnalyzer = null;
        let remoteAnalyzer = null;
        let audioVisualizerInterval = null;

        // STUN —Å–µ—Ä–≤–µ—Ä—ã
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const registerSection = document.querySelector('.register-section');
        const loginSection = document.querySelector('.login-section');
        const callSection = document.querySelector('.call-section');
        const callingSection = document.querySelector('.calling-section');
        const incomingCallSection = document.querySelector('.incoming-call-section');
        const inCallSection = document.querySelector('.in-call-section');
        const usersContainer = document.getElementById('usersContainer');
        const registerBtn = document.getElementById('registerBtn');
        const loginBtn = document.getElementById('loginBtn');
        const showLoginLink = document.getElementById('showLogin');
        const showRegisterLink = document.getElementById('showRegister');
        const logoutBtn = document.getElementById('logoutBtn');
        const cancelCallBtn = document.getElementById('cancelCallBtn');
        const declineBtn = document.getElementById('declineBtn');
        const acceptBtn = document.getElementById('acceptBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const callingUserEl = document.getElementById('callingUser');
        const incomingUserEl = document.getElementById('incomingUser');
        const currentCallUserEl = document.getElementById('currentCallUser');
        const callDurationEl = document.getElementById('callDuration');
        const notificationEl = document.getElementById('notification');
        const currentUsernameDisplay = document.getElementById('currentUsernameDisplay');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        
        // –ü–æ–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        const regUsernameInput = document.getElementById('regUsername');
        const regPasswordInput = document.getElementById('regPassword');
        const regUsernameError = document.getElementById('regUsernameError');
        const regPasswordError = document.getElementById('regPasswordError');
        
        // –ü–æ–ª—è –≤—Ö–æ–¥–∞
        const loginUsernameInput = document.getElementById('loginUsername');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginUsernameError = document.getElementById('loginUsernameError');
        const loginPasswordError = document.getElementById('loginPasswordError');

        // API URL
        const API_URL = window.location.origin;

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –∏ –≤—Ö–æ–¥–æ–º
        showLoginLink.addEventListener('click', () => {
            switchSection('login');
        });

        showRegisterLink.addEventListener('click', () => {
            switchSection('register');
        });

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        registerBtn.addEventListener('click', async () => {
            const username = regUsernameInput.value.trim();
            const password = regPasswordInput.value;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            let isValid = true;
            
            if (username.length < 3) {
                showError(regUsernameError, '–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤');
                isValid = false;
            } else {
                hideError(regUsernameError);
            }
            
            if (username.length > 20) {
                showError(regUsernameError, '–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –±–æ–ª–µ–µ 20 —Å–∏–º–≤–æ–ª–æ–≤');
                isValid = false;
            } else {
                hideError(regUsernameError);
            }
            
            if (password.length < 4) {
                showError(regPasswordError, '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 4 —Å–∏–º–≤–æ–ª–æ–≤');
                isValid = false;
            } else {
                hideError(regPasswordError);
            }
            
            if (!isValid) return;
            
            try {
                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'success');
                    switchSection('login');
                    loginUsernameInput.value = username;
                } else {
                    showError(regUsernameError, data.detail || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                showError(regUsernameError, '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        });

        // –í—Ö–æ–¥
        loginBtn.addEventListener('click', async () => {
            const username = loginUsernameInput.value.trim();
            const password = loginPasswordInput.value;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            let isValid = true;
            
            if (!username) {
                showError(loginUsernameError, '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                isValid = false;
            } else {
                hideError(loginUsernameError);
            }
            
            if (!password) {
                showError(loginPasswordError, '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                isValid = false;
            } else {
                hideError(loginPasswordError);
            }
            
            if (!isValid) return;
            
            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
                    sessionId = data.session_id;
                    currentUserId = data.user_id;
                    currentUsername = data.username;
                    
                    showNotification('–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!', 'success');
                    currentUsernameDisplay.textContent = `üë§ ${currentUsername}`;
                    
                    // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket
                    connectWebSocket();
                    
                } else {
                    showError(loginUsernameError, data.detail || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                showError(loginUsernameError, '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        });

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
        function connectWebSocket() {
            socket = new WebSocket(`${API_URL.replace('http', 'ws')}/ws/${sessionId}`);

            socket.onopen = () => {
                console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                showNotification('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
                switchSection('call');
            };

            socket.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleMessage(message);
            };

            socket.onclose = (event) => {
                console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω', event.code);
                
                if (event.code === 4001) {
                    showNotification('–°–µ—Å—Å–∏—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞', 'error');
                    logout();
                } else {
                    showNotification('–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞', 'error');
                }
                
                // –ï—Å–ª–∏ –±—ã–ª –∑–≤–æ–Ω–æ–∫ - –∑–∞–≤–µ—Ä—à–∞–µ–º
                if (peerConnection || incomingCallSection.classList.contains('active')) {
                    hangupCall();
                }
            };

            socket.onerror = (error) => {
                console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
            };
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        function handleMessage(message) {
            const type = message.type;

            switch (type) {
                case 'online_users':
                    allUsers = message.users.filter(u => u.user_id !== message.current_user_id);
                    updateOnlineUsers(allUsers);
                    break;

                case 'incoming_call':
                    handleIncomingCall(message);
                    break;

                case 'call_answered':
                    handleCallAnswered(message);
                    break;

                case 'ice_candidate':
                    handleIceCandidate(message);
                    break;

                case 'call_declined':
                    handleCallDeclined(message);
                    break;

                case 'call_ended':
                    handleCallEnded();
                    break;

                case 'error':
                    showNotification(message.message || '–û—à–∏–±–∫–∞', 'error');
                    break;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function updateOnlineUsers(users) {
            if (users.length === 0) {
                usersContainer.innerHTML = `
                    <div class="empty-state">
                        <p>üòï –ù–µ—Ç –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                        <p style="font-size: 12px; margin-top: 5px;">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π —Å –¥—Ä—É–≥–æ–º</p>
                    </div>
                `;
                searchResults.textContent = '';
                return;
            }

            let html = '';
            users.forEach(user => {
                html += `
                    <div class="user-item" onclick="initiateCall(${user.user_id}, '${escapeHtml(user.username)}')">
                        <span class="username">${escapeHtml(user.username)}</span>
                        <span class="status">–û–Ω–ª–∞–π–Ω</span>
                    </div>
                `;
            });
            usersContainer.innerHTML = html;
            searchResults.textContent = `–ù–∞–π–¥–µ–Ω–æ: ${users.length}`;
        }

        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function searchUsers(query) {
            if (!query.trim()) {
                updateOnlineUsers(allUsers);
                return;
            }
            
            const filteredUsers = allUsers.filter(user => 
                user.username.toLowerCase().includes(query.toLowerCase())
            );
            
            updateOnlineUsers(filteredUsers);
        }

        // –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –∑–≤–æ–Ω–∫–∞
        async function initiateCall(targetUserId, targetUsername) {
            try {
                console.log('üìû –ù–∞—á–∏–Ω–∞–µ–º –∑–≤–æ–Ω–æ–∫:', targetUsername);
                
                if (!socket || socket.readyState !== WebSocket.OPEN) {
                    throw new Error('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                // –°–æ–∑–¥–∞–µ–º PeerConnection
                peerConnection = new RTCPeerConnection(rtcConfig);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                peerConnection.onicecandidate = handleIceCandidateEvent;
                peerConnection.ontrack = handleTrackEvent;
                peerConnection.oniceconnectionstatechange = handleConnectionStateChange;
                
                // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
                const offer = await peerConnection.createOffer({
                    offerToReceiveAudio: true
                });
                await peerConnection.setLocalDescription(offer);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
                socket.send(JSON.stringify({
                    type: 'call_user',
                    target_user_id: targetUserId,
                    offer: offer
                }));
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—ã–∑–æ–≤–∞
                callingUserEl.textContent = targetUsername;
                currentCallUser = targetUserId;
                switchSection('calling');
                showNotification(`–í—ã–∑–æ–≤ ${targetUsername}...`);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–≤–æ–Ω–∫–∞:', error);
                let errorMsg = '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫';
                
                if (error.name === 'NotAllowedError') {
                    errorMsg = '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω';
                } else if (error.message) {
                    errorMsg = error.message;
                }
                
                showNotification(errorMsg, 'error');
                
                cleanupResources();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
        function handleIncomingCall(message) {
            incomingUserEl.textContent = message.from_username;
            currentCallUser = message.from_user_id;
            
            showNotification(`üìû –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤ –æ—Ç ${message.from_username}`, 'incoming');
            
            incomingCallSection.classList.add('active');
            callSection.classList.remove('active');
            
            // –°–æ–∑–¥–∞–µ–º –æ—Ç–≤–µ—Ç –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏
            acceptBtn.onclick = async () => {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    peerConnection = new RTCPeerConnection(rtcConfig);
                    
                    localStream.getTracks().forEach(track => {
                        peerConnection.addTrack(track, localStream);
                    });
                    
                    peerConnection.onicecandidate = handleIceCandidateEvent;
                    peerConnection.ontrack = handleTrackEvent;
                    peerConnection.oniceconnectionstatechange = handleConnectionStateChange;
                    
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
                    
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    
                    socket.send(JSON.stringify({
                        type: 'answer_call',
                        target_user_id: currentCallUser,
                        answer: answer
                    }));
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–≤–æ–Ω–∫–∞
                    currentCallUserEl.textContent = message.from_username;
                    startCallTimer();
                    switchSection('in-call');
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–≤–æ–Ω–∫–∞:', error);
                    showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–Ω—è—Ç—å –∑–≤–æ–Ω–æ–∫', 'error');
                    declineCall();
                }
            };
            
            declineBtn.onclick = declineCall;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∑–≤–æ–Ω–æ–∫
        async function handleCallAnswered(message) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
                
                const user = allUsers.find(u => u.user_id === currentCallUser);
                if (user) {
                    currentCallUserEl.textContent = user.username;
                }
                
                startCallTimer();
                switchSection('in-call');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
                cleanupResources();
            }
        }

        // –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
        function declineCall() {
            if (currentCallUser && socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'call_declined',
                    target_user_id: currentCallUser
                }));
            }
            
            cleanupResources();
            switchSection('call');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–∫–æ–≥–¥–∞ –æ—Ç–∫–ª–æ–Ω—è—é—Ç –Ω–∞—Å)
        function handleCallDeclined(message) {
            console.log('üìû –ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
            showNotification('–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω', 'info');
            cleanupResources();
            switchSection('call');
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
        function hangupCall() {
            if (currentCallUser && socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'call_ended',
                    target_user_id: currentCallUser
                }));
            }
            
            cleanupResources();
            switchSection('call');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞ (–∫–æ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∞—é—Ç —Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã)
        function handleCallEnded() {
            console.log('üìû –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
            showNotification('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'info');
            cleanupResources();
            switchSection('call');
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
        function cleanupResources() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä
            if (audioVisualizerInterval) {
                clearInterval(audioVisualizerInterval);
                audioVisualizerInterval = null;
            }
            
            // –û—á–∏—â–∞–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—ã
            if (localAnalyzer) {
                localAnalyzer.disconnect();
                localAnalyzer = null;
            }
            if (remoteAnalyzer) {
                remoteAnalyzer.disconnect();
                remoteAnalyzer = null;
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫–∏
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            callDurationEl.textContent = '00:00';
            currentCallUser = null;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
        function handleIceCandidateEvent(event) {
            if (event.candidate && socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'ice_candidate',
                    target_user_id: currentCallUser,
                    candidate: event.candidate
                }));
            }
        }

        function handleIceCandidate(message) {
            if (peerConnection && message.candidate) {
                peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate))
                    .catch(error => console.error('ICE error:', error));
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–µ–∫–æ–≤
        function handleTrackEvent(event) {
            remoteStream = event.streams[0];
            console.log('‚úÖ –£–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω');
            
            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫
            const remoteAudio = document.getElementById('remoteAudio');
            remoteAudio.srcObject = remoteStream;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä
            initAudioAnalyzer(remoteStream, 'remote');
        }

        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function handleConnectionStateChange() {
            if (peerConnection && peerConnection.iceConnectionState === 'failed') {
                console.log('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å');
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
                hangupCall();
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –∑–≤—É–∫–∞
        function initAudioAnalyzer(stream, type) {
            try {
                if (!audioContext) {
                    window.AudioContext = window.AudioContext || window.webkitAudioContext;
                    audioContext = new AudioContext();
                }
                
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.8;
                
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                
                if (type === 'local') {
                    localAnalyzer = analyser;
                } else if (type === 'remote') {
                    remoteAnalyzer = analyser;
                }
                
                return analyser;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞:', error);
                return null;
            }
        }

        // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
        function startCallTimer() {
            startTime = Date.now();
            callTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                callDurationEl.textContent = `${minutes}:${seconds}`;
            }, 1000);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä
            if (localStream) {
                initAudioAnalyzer(localStream, 'local');
            }
            startAudioVisualizer();
        }

        // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤—É–∫–∞
        function startAudioVisualizer() {
            if (audioVisualizerInterval) {
                clearInterval(audioVisualizerInterval);
            }
            
            audioVisualizerInterval = setInterval(() => {
                updateLevel('micLevel', localAnalyzer);
                updateLevel('remoteLevel', remoteAnalyzer);
            }, 100);
        }

        function updateLevel(containerId, analyser) {
            if (!analyser) return;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteTimeDomainData(dataArray);
            
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += Math.abs(dataArray[i] - 128);
            }
            const average = sum / dataArray.length;
            const normalized = Math.min(1, average / 50);
            
            const bars = document.querySelectorAll(`#${containerId} > .level-bar`);
            const activeCount = Math.floor(normalized * bars.length);
            
            bars.forEach((bar, index) => {
                if (index < activeCount) {
                    bar.classList.add('active');
                    if (index > activeCount - 3 && normalized > 0.7) {
                        bar.classList.add('very-active');
                    } else {
                        bar.classList.remove('very-active');
                    }
                } else {
                    bar.classList.remove('active', 'very-active');
                }
            });
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π
        function switchSection(section) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
            registerSection.classList.remove('active');
            loginSection.classList.remove('active');
            callSection.classList.remove('active');
            callingSection.classList.remove('active');
            incomingCallSection.classList.remove('active');
            inCallSection.classList.remove('active');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é
            switch (section) {
                case 'register':
                    registerSection.classList.add('active');
                    break;
                case 'login':
                    loginSection.classList.add('active');
                    break;
                case 'call':
                    callSection.classList.add('active');
                    break;
                case 'calling':
                    callingSection.classList.add('active');
                    break;
                case 'incoming':
                    incomingCallSection.classList.add('active');
                    break;
                case 'in-call':
                    inCallSection.classList.add('active');
                    break;
            }
        }

        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(message, type = 'info') {
            notificationEl.textContent = message;
            notificationEl.style.display = 'block';
            
            setTimeout(() => {
                notificationEl.style.display = 'none';
            }, 3000);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(element, message) {
            element.textContent = message;
            element.classList.add('show');
        }

        // –°–∫—Ä—ã—Ç—å –æ—à–∏–±–∫—É
        function hideError(element) {
            element.textContent = '';
            element.classList.remove('show');
        }

        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        function logout() {
            // –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é
            sessionId = null;
            currentUserId = null;
            currentUsername = null;
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (socket) {
                socket.close();
                socket = null;
            }
            
            // –û—á–∏—â–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã
            cleanupResources();
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
            switchSection('login');
            showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        logoutBtn.addEventListener('click', logout);
        cancelCallBtn.addEventListener('click', () => {
            hangupCall();
        });
        hangupBtn.addEventListener('click', hangupCall);
        declineBtn.addEventListener('click', declineCall);

        // –ü–æ–∏—Å–∫ –ø–æ –≤–≤–æ–¥—É
        searchInput.addEventListener('input', (e) => {
            searchUsers(e.target.value);
        });

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
            if (!navigator.mediaDevices) {
                alert('‚ö†Ô∏è –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome, Firefox –∏–ª–∏ Edge');
                return;
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (peerConnection) {
                peerConnection.close();
            }
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.close();
            }
            cleanupResources();
        });
    </script>
</body>
</html>